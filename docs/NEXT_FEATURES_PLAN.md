# 제작 의뢰 관리 – 추가 기능 구현 방안 정리

확인만 요청하신 항목(파일 업로드, 푸시 알림)을 **어떤 방식으로 구현할지** 효율·사용자 편의·유지보수를 고려해 정리했습니다. 검토 후 진행 방식을 결정하시면 됩니다.

---

## 1. 파일 직접 업로드

### 현재
- 파일 **링크(URL)** 입력만 가능.

### 목표
- 의뢰서에서 **파일을 직접 선택해 업로드**하고, 저장된 파일 URL을 자동으로 `file_link`에 반영.

### 방식 비교

| 방식 | 저장 위치 | 용량 제한 | 비용 | 유지보수 | 비고 |
|------|-----------|-----------|------|----------|------|
| **A. Vercel Blob** | Vercel 제공 스토리지 | 플랜별 제한 | Hobby 무료 한도 내, 초과 시 유료 | Vercel 대시보드·문서로 관리 용이 | **권장** – 이미 Vercel 배포 시 연동 단순 |
| **B. AWS S3** | AWS 클라우드 | 서비스 제한 내 자유 설정 | 사용량 과금 | AWS 콘솔·IAM·버킷 정책 관리 필요 | 대용량·다른 AWS 서비스와 연동 시 |
| **C. 클라이언트 → 저장소 직접** | Blob/S3 등 | 동일 | 동일 | Presigned URL 등 한 번 구성 후 유지 | 4.5MB 제한 회피, 대용량에 유리 |

### 제약(공통)
- **Vercel Serverless**: API를 경유하는 요청 본문 **약 4.5MB** 제한.  
  → 큰 파일은 “클라이언트 → 저장소 직접 업로드” 후 URL만 API로 전달하는 방식이 유리.

### 권장
- **저장소**: **Vercel Blob** (이미 Vercel 사용 중이면 설정·운영이 가장 단순).
- **업로드 흐름**:  
  - 4.5MB 이하: API Route에서 Blob `put()` 후 URL 반환 → 폼에서 `file_link`에 설정.  
  - 4.5MB 초과 필요 시: 클라이언트에서 Blob 직접 업로드(또는 Presigned URL) 후 받은 URL만 서버로 전달.

---

## 2. 새 의뢰 시 푸시 알림 (카카오톡/문자)

### 목표
- 의뢰서 **작성 완료 시**  
  - **(1)** 선택/입력한 **출력업체 연락처**로 알림  
  - **(2)** **관리자**에게도 동시 알림  

### 필요한 데이터(현재 없음)
- **출력업체별 수신 번호**: 출력실명(예: 크림팩토리) → 알림 받을 전화번호.
- **관리자 수신 번호**: 1명 또는 여러 명.

---

### 방식 비교: 알림 “누가 보내는가”

| 방식 | 발송 주체 | 연동 난이도 | 비용·계약 | 유지보수 | 실시간성 |
|------|-----------|-------------|-----------|----------|----------|
| **A. Make + 웹훅** | Make 시나리오가 알림톡/SMS API 호출 | 중 | Make 플랜 + 알림톡/SMS 업체 | Make 시나리오·템플릿만 수정 | 즉시 |
| **B. Make + 시트 감시** | Make가 시트 새 행 감지 후 발송 | 하 (앱 코드 수정 없음) | 동일 | Make만 수정 | 2~15분 지연 가능 |
| **C. 앱에서 직접 API** | 우리 서버가 SOLAPI 등 호출 | 상 (코드·env·배포) | 알림톡/SMS 업체만 | 코드·env·모니터링 | 즉시 |

---

### A. Make + 웹훅 (권장)

**흐름**
1. 의뢰 저장 성공 시 우리 API에서 **Make 웹훅 URL**로 POST (의뢰 요약 + 수신 대상 정보).
2. Make 시나리오: 웹훅 수신 → **(출력업체 번호 조회)** → 알림톡/문자 발송(출력업체 1통 + 관리자 1통 또는 N통).

**필요한 것**
- Make 시나리오: Webhook 트리거 + (선택) Google 시트에서 “출력실명 → 수신번호” 조회 + HTTP로 SOLAPI(또는 알림톡 API) 호출.
- 우리 쪽: **의뢰 생성 API 1곳**에서 성공 시 웹훅 1회 호출 + **출력업체 연락처**를 어딘가에 정의(시트 권장).

**장점**
- 알림 로직·템플릿 변경이 **Make에서만** 이루어져, 앱 배포 없이 수정 가능.
- SOLAPI 등 API 키·템플릿을 Make에만 두면 앱 코드는 단순(웹훅 URL + payload만 전달).
- 출력업체 추가/번호 변경을 **시트**로 하면 비개발자도 유지보수 가능.

**단점**
- Make 시나리오 설계·연동 한 번 필요.
- Make 플랜·알림톡/SMS 비용은 별도.

---

### B. Make + 시트 감시

**흐름**
1. 우리 앱은 **기존처럼** 의뢰만 시트에 저장.
2. Make: Google Sheets “Watch new rows” → 새 행 감지 → (출력업체명으로 번호 조회) → 알림 발송.

**장점**
- **앱 코드 수정 없음.** Make만 설정하면 됨.

**단점**
- 폴링이라 **몇 분 지연** 가능.
- 시트 감시 오퍼레이션 사용.

---

### C. 앱에서 직접 알림 API 호출

**흐름**
1. 의뢰 저장 성공 후 같은 API(또는 내부 함수)에서 SOLAPI 등 **알림톡/SMS API** 직접 호출.
2. 출력업체 번호는 시트/DB에서 조회, 관리자 번호는 env 또는 시트.

**장점**
- 실시간, Make 의존 없음.

**단점**
- API 키·템플릿 코드가 앱(env)에 들어가서 **보안·배포** 관리 필요.
- 템플릿/문구 변경 시 **코드 또는 env 수정 후 재배포** 필요.

---

### 권장: **Make + 웹훅**

- **효율**: 알림 로직·수신자·템플릿을 Make와 시트로 분리해, 앱은 “의뢰 저장 + 웹훅 1번 호출”만 담당.
- **사용자 편의**: 출력업체 추가/번호 변경은 시트만 수정하면 됨.
- **유지보수**: 템플릿·발송 조건 변경 시 Make 시나리오만 수정, 앱 배포 최소화.

---

## 3. 수신자 데이터 설계 (출력업체 + 관리자)

알림을 “선택한 출력업체” + “관리자” 둘 다에게 보내려면 아래만 정해 두면 됩니다.

| 데이터 | 저장 위치 제안 | 용도 |
|--------|----------------|------|
| **출력업체별 수신 번호** | Google 시트 **새 탭** `vendor_contacts` (출력실명, 수신전화번호) 또는 기존 `spec_master`에 “기본 출력실 연락처” 컬럼 | 의뢰의 `vendor`로 조회 → 해당 번호로 1통 발송 |
| **관리자 수신 번호** | 환경 변수 `ADMIN_NOTIFY_PHONE` (1명) 또는 시트 `settings` 같은 곳에 목록 | 의뢰 생성 시 항상 관리자 번호로 1통(또는 N통) 발송 |

Make 사용 시:
- “출력업체 번호”는 Make에서 **Google 시트**로 조회하거나, 우리가 웹훅 payload에 “이번 의뢰의 출력업체 수신 번호”를 넣어서 보내도 됨.
- “관리자 번호”는 Make 시나리오에 고정으로 넣거나, 웹훅 payload에 포함해도 됨.

---

## 4. 구현 순서 제안 (결정 시 참고)

1. **알림 (Make + 웹훅)**  
   - 출력업체 연락처 시트(또는 spec 확장) 정의  
   - Make 시나리오: Webhook 수신 → 수신자 결정(출력업체 + 관리자) → 알림톡/SMS 발송  
   - 우리 API: 의뢰 저장 성공 시 웹훅 1회 호출 (job_id, vendor, 요약, 수신용 정보 등)

2. **파일 업로드 (선택)**  
   - Vercel Blob 설정  
   - 업로드 API 또는 클라이언트 직접 업로드 후 `file_link` 반영  
   - 새 의뢰 폼에 파일 선택 UI 추가

3. **관리자 번호**  
   - 초기에는 env 1개로 시작해도 되고, 나중에 시트/설정으로 확장 가능.

---

## 5. 요약 표

| 기능 | 권장 방식 | 이유 |
|------|-----------|------|
| 파일 직접 업로드 | Vercel Blob + (필요 시 클라이언트 직접 업로드) | Vercel과 통합 단순, 4.5MB 제한 회피 가능 |
| 새 의뢰 푸시 알림 | **Make + 웹훅** | 템플릿·수신자 변경을 Make/시트로 처리해 유지보수와 편의성 좋음 |
| 출력업체 연락처 | 시트 `vendor_contacts` 또는 spec 확장 | 비개발자 수정 용이 |
| 관리자 연락처 | env 또는 시트 | 고정 1명은 env, 다수·변경 많으면 시트 |

이 문서 기준으로 “알림만 먼저 / 파일만 먼저 / 둘 다” 등 진행 순서를 정하시면, 그에 맞춰 단계별 구현 가이드도 정리해 드릴 수 있습니다.
